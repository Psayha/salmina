// Prisma Schema для Telegram Shop v1.1
// Database: PostgreSQL 15+

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum OrderStatus {
  PAID
  PROCESSING
  SHIPPED
  CANCELLED
}

enum PaymentMethod {
  SBP
  CASH_ON_DELIVERY
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum DiscountType {
  PERCENT
  FIXED
}

enum LegalDocumentType {
  TERMS
  PRIVACY
  OFFER
  DELIVERY_PAYMENT
}

model User {
  id                String    @id @default(uuid())
  telegramId        BigInt    @unique
  username          String?
  firstName         String
  lastName          String?
  photoUrl          String?
  phone             String?
  email             String?
  role              UserRole  @default(USER)
  isActive          Boolean   @default(true)
  hasAcceptedTerms  Boolean   @default(false)
  termsAcceptedAt   DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  orders            Order[]
  cart              Cart?
  favorites         Favorite[]
  wishlistShares    WishlistShare[]

  @@index([telegramId])
  @@index([role])
  @@map("users")
}

model Category {
  id          String     @id @default(uuid())
  name        String
  slug        String     @unique
  description String?
  parentId    String?
  order       Int        @default(0)
  image       String?
  showOnHome  Boolean    @default(false)
  homeOrder   Int?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[] @relation("CategoryTree")
  products    Product[]

  @@index([parentId])
  @@index([slug])
  @@index([showOnHome, homeOrder])
  @@map("categories")
}

model Product {
  id              String    @id @default(uuid())
  categoryId      String
  name            String
  slug            String    @unique
  description     String    @db.Text
  price           Decimal   @db.Decimal(10, 2)
  promotionPrice  Decimal?  @db.Decimal(10, 2)
  discountPrice   Decimal?  @db.Decimal(10, 2)
  article         String    @unique
  sku             String    @unique
  weight          Decimal   @db.Decimal(8, 2)
  dimensions      String?
  quantity        Int       @default(0)
  composition     String?   @db.Text
  delivery        String?   @db.Text
  characteristics Json?
  application     String?   @db.Text
  images          String[]
  isNew           Boolean   @default(false)
  isHit           Boolean   @default(false)
  isDiscount      Boolean   @default(false)
  hasPromotion    Boolean   @default(false)
  viewCount       Int       @default(0)
  orderCount      Int       @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  category        Category  @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  cartItems       CartItem[]
  orderItems      OrderItem[]
  favorites       Favorite[]

  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
  @@index([isNew, isHit, isDiscount])
  @@index([hasPromotion])
  @@map("products")
}

model Promotion {
  id          String    @id @default(uuid())
  title       String
  description String?   @db.Text
  image       String
  link        String?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  validFrom   DateTime?
  validTo     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive, order])
  @@index([validFrom, validTo])
  @@map("promotions")
}

model Cart {
  id        String     @id @default(uuid())
  userId    String?    @unique
  sessionToken String? @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime?

  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([userId])
  @@index([sessionToken])
  @@map("carts")
}

model CartItem {
  id              String   @id @default(uuid())
  cartId          String
  productId       String
  quantity        Int      @default(1)
  price           Decimal  @db.Decimal(10, 2)
  appliedPrice    Decimal  @db.Decimal(10, 2)
  hasPromotion    Boolean  @default(false)
  allowPromocode  Boolean  @default(true)
  createdAt       DateTime @default(now())

  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model Promocode {
  id            String       @id @default(uuid())
  code         String       @unique
  discountType DiscountType
  discountValue Decimal      @db.Decimal(10, 2)
  minOrderAmount Decimal?    @db.Decimal(10, 2)
  maxUses      Int?
  usedCount    Int          @default(0)
  isActive     Boolean      @default(true)
  validFrom    DateTime
  validTo      DateTime
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  orders       Order[]

  @@index([code])
  @@index([isActive, validFrom, validTo])
  @@map("promocodes")
}

model Order {
  id                String        @id @default(uuid())
  orderNumber       String        @unique
  userId            String
  status            OrderStatus   @default(PAID)
  customerName      String
  customerPhone     String
  customerEmail     String
  customerAddress   String        @db.Text
  comment           String?       @db.Text
  subtotal          Decimal       @db.Decimal(10, 2)
  discount          Decimal       @default(0) @db.Decimal(10, 2)
  total             Decimal       @db.Decimal(10, 2)
  promocodeId       String?
  promocodeDiscount Decimal?      @db.Decimal(10, 2)
  trackingNumber    String?
  paymentMethod     PaymentMethod
  paymentStatus     PaymentStatus @default(PENDING)
  paymentId         String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  paidAt            DateTime?
  shippedAt         DateTime?

  user              User          @relation(fields: [userId], references: [id], onDelete: Restrict)
  promocode         Promocode?    @relation(fields: [promocodeId], references: [id], onDelete: SetNull)
  items             OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id            String   @id @default(uuid())
  orderId       String
  productId     String
  productName   String
  productArticle String
  productImage  String
  basePrice     Decimal  @db.Decimal(10, 2)
  appliedPrice  Decimal  @db.Decimal(10, 2)
  hadPromotion  Boolean  @default(false)
  quantity      Int
  createdAt     DateTime @default(now())

  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("favorites")
}

model WishlistShare {
  id        String    @id @default(uuid())
  userId    String
  shareId   String    @unique
  title     String?
  qrCodeUrl String?
  isActive  Boolean   @default(true)
  viewCount Int       @default(0)
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([shareId])
  @@index([isActive])
  @@map("wishlist_shares")
}

model LegalDocument {
  id          String            @id @default(uuid())
  type        LegalDocumentType
  title       String
  content     String            @db.Text
  version     String
  isActive    Boolean           @default(true)
  publishedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([type, version])
  @@index([type, isActive])
  @@map("legal_documents")
}

