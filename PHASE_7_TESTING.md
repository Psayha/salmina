# Phase 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –ù–∞—á–∞–ª–æ

**–°—Ç–∞—Ç—É—Å:** üöß –í –ø—Ä–æ—Ü–µ—Å—Å–µ
**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:** 16 –Ω–æ—è–±—Ä—è 2025

---

## üìã –û–±–∑–æ—Ä

Phase 7 —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏ –¥–ª—è backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**Jest –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Jest 30.2.0 —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ESM
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω ts-jest –¥–ª—è TypeScript
- ‚úÖ –°–æ–∑–¥–∞–Ω jest.config.js —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ES –º–æ–¥—É–ª–µ–π
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω jest.setup.js —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**package.json —Å–∫—Ä–∏–ø—Ç—ã:**
```json
{
  "test": "NODE_OPTIONS=--experimental-vm-modules jest",
  "test:watch": "NODE_OPTIONS=--experimental-vm-modules jest --watch",
  "test:coverage": "NODE_OPTIONS=--experimental-vm-modules jest --coverage"
}
```

### 2. Unit —Ç–µ—Å—Ç—ã –¥–ª—è Prodamus Service

**–§–∞–π–ª:** `src/services/__tests__/prodamus.service.test.ts`

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**
- ‚úÖ generatePaymentLink() - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
- ‚úÖ verifyWebhookSignature() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook
- ‚úÖ parseWebhookProducts() - –ø–∞—Ä—Å–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ JSON
- ‚úÖ isPaymentSuccessful() - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–ø–ª–∞—Ç—ã

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ 12 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ
- ‚ö†Ô∏è 2 —Ç–µ—Å—Ç–∞ —Ç—Ä–µ–±—É—é—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ (URL encoding)
- üìä –ü–æ–∫—Ä—ã—Ç–∏–µ: ~85%

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã

1. `jest.config.js` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Jest
2. `jest.setup.js` - setup –¥–ª—è —Ç–µ—Å—Ç–æ–≤
3. `src/services/__tests__/prodamus.service.test.ts` - —Ç–µ—Å—Ç—ã payment service

### –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã

```
jest@30.2.0
ts-jest@29.4.5
@jest/globals@30.2.0
@types/jest@30.0.0
```

---

## üéØ –ü–ª–∞–Ω –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Ä–∞–±–æ—Ç

### Unit —Ç–µ—Å—Ç—ã

- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å 2 –ø–∞–¥–∞—é—â–∏—Ö —Ç–µ—Å—Ç–∞ –≤ prodamus.service.test.ts
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è auth service
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è orders service
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è products service
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è cart service

### Integration —Ç–µ—Å—Ç—ã

- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Supertest
- [ ] –¢–µ—Å—Ç—ã API endpoints:
  - POST /api/auth/telegram
  - POST /api/orders
  - POST /webhooks/prodamus
  - GET /api/products
  - GET /api/categories

### E2E —Ç–µ—Å—Ç—ã

- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Playwright (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –¢–µ—Å—Ç—ã –ø–æ–ª–Ω–æ–≥–æ flow –∑–∞–∫–∞–∑–∞
- [ ] –¢–µ—Å—Ç—ã –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ flow

### CI/CD Integration

- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ GitHub Actions
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å coverage —Ä–µ–ø–æ—Ä—Ç—ã
- [ ] –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è

---

## üìù –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤

### Unit —Ç–µ—Å—Ç (—Ä–∞–±–æ—Ç–∞—é—â–∏–π)

```typescript
it('–¥–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å –¥–ª—è –¥–∞–Ω–Ω—ã—Ö', () => {
  const params = {
    orderNumber: 'TEST-123',
    customerName: 'Test User',
    products: [
      { name: 'Product', price: 100, quantity: 1 },
    ],
  };

  const url1 = prodamusService.generatePaymentLink(params);
  const url2 = prodamusService.generatePaymentLink(params);

  // –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –¥–∞–≤–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å
  const sign1 = new URL(url1).searchParams.get('sign');
  const sign2 = new URL(url2).searchParams.get('sign');
  expect(sign1).toBe(sign2);
});
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—É—Å–∫–∞

```bash
$ pnpm test

PASS src/services/__tests__/prodamus.service.test.ts
  ProdamusService
    generatePaymentLink
      ‚úì –¥–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (2 ms)
      ‚úì –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (1 ms)
    verifyWebhookSignature
      ‚úì –¥–æ–ª–∂–µ–Ω –æ—Ç–∫–ª–æ–Ω—è—Ç—å –Ω–µ–≤–µ—Ä–Ω—É—é –ø–æ–¥–ø–∏—Å—å (1 ms)
      ‚úì –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å false –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (1 ms)
    parseWebhookProducts
      ‚úì –¥–æ–ª–∂–µ–Ω –ø–∞—Ä—Å–∏—Ç—å JSON –º–∞—Å—Å–∏–≤ —Ç–æ–≤–∞—Ä–æ–≤ (1 ms)
      ‚úì –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
      ‚úì –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º JSON (2 ms)
      ‚úì –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã —Å —Ä–∞–∑–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –∫–ª—é—á–µ–π
    isPaymentSuccessful
      ‚úì –¥–æ–ª–∂–µ–Ω –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É –ø–æ —Å—Ç–∞—Ç—É—Å—É "success"
      ‚úì –¥–æ–ª–∂–µ–Ω –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º
      ‚úì –¥–æ–ª–∂–µ–Ω –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –Ω–µ—É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É (1 ms)
      ‚úì –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å case-insensitive

Tests:       12 passed, 14 total
```

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. URL Encoding –≤ —Ç–µ—Å—Ç–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–¥–∏—Ä—É—é—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É `customer_email=ivan@example.com` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `customer_email=ivan%40example.com`

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å URLSearchParams –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–ª–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å URL

### 2. Buffer Length –≤ crypto

**–ü—Ä–æ–±–ª–µ–º–∞:** `timingSafeEqual` —Ç—Ä–µ–±—É–µ—Ç –±—É—Ñ–µ—Ä—ã –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –¥–ª–∏–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å –¥–ª–∏–Ω—É –ø–æ–¥–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º

---

## üìö –†–µ—Å—É—Ä—Å—ã

- [Jest Documentation](https://jestjs.io/)
- [ts-jest Documentation](https://kulshekhar.github.io/ts-jest/)
- [Testing Best Practices](https://github.com/goldbergyoni/javascript-testing-best-practices)

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç Phase 7

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞
- [x] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Jest –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- [x] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è ESM
- [x] –î–æ–±–∞–≤–∏—Ç—å npm —Å–∫—Ä–∏–ø—Ç—ã
- [x] –°–æ–∑–¥–∞—Ç—å jest.setup.js

### Unit —Ç–µ—Å—Ç—ã
- [x] Prodamus service (85% –≥–æ—Ç–æ–≤–æ)
- [ ] Auth service
- [ ] Orders service
- [ ] Products service
- [ ] Cart service

### Integration —Ç–µ—Å—Ç—ã
- [ ] Setup Supertest
- [ ] API endpoints —Ç–µ—Å—Ç—ã
- [ ] Webhook —Ç–µ—Å—Ç—ã

### Coverage
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å coverage —Ä–µ–ø–æ—Ä—Ç—ã
- [ ] –¶–µ–ª—å: >80% –ø–æ–∫—Ä—ã—Ç–∏—è
- [ ] CI/CD integration

---

**–°—Ç–∞—Ç—É—Å:** üöß –í –ø—Ä–æ—Ü–µ—Å—Å–µ - –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞, –Ω–∞—á–∞—Ç—ã unit —Ç–µ—Å—Ç—ã

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–∞–¥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
